name: Push a new tag with minor update

on:
     push:
          branches:
               - main

jobs:
     docker:
          name: Build Docker Image
          runs-on: ubuntu-latest
          outputs:
               json: ${{ steps.meta.outputs.json }}
          steps:
               - name: Checkout
                 uses: actions/checkout@v4
                 with:
                      fetch-depth: 0
                      lfs: true

               - name: Docker Meta
                 id: meta
                 uses: docker/metadata-action@v5
                 with:
                      images: spreadorganization/docs-internal
                      tags: |
                           type=schedule
                           type=semver,pattern={{version}}
                           type=semver,pattern={{major}}.{{minor}}
                           type=semver,pattern={{major}}
                           type=ref,event=branch,suffix=-{{sha}}-${{ github.run_number }}
                           type=ref,event=branch
                           type=sha

               - name: Set up QEMU
                 uses: docker/setup-qemu-action@v3

               - name: Set up Docker Buildx
                 uses: docker/setup-buildx-action@v3

               - name: Login to Docker Hub
                 uses: docker/login-action@v3
                 with:
                      username: ${{ secrets.DOCKER_USERNAME }}
                      password: ${{ secrets.DOCKER_PASSWORD }}
                      
     zip:
          runs-on: ubuntu-latest
          steps:
               - name: Install zip
                 run: ls -al
               - name: Zip the Vale Package
                 run: zip -r spread.zip spread/

     release:
          runs-on: ubuntu-latest
          steps:
               - uses: actions/checkout@v2

               - uses: actions-ecosystem/action-get-latest-tag@v1
                 id: get-latest-tag

               - uses: actions-ecosystem/action-bump-semver@v1
                 id: bump-semver
                 with:
                      current_version: ${{ steps.get-latest-tag.outputs.tag }}
                      level: minor

               - uses: actions-ecosystem/action-push-tag@v1
                 with:
                      tag: ${{ steps.bump-semver.outputs.new_version }}
                      message: '${{ steps.bump-semver.outputs.new_version }}: PR #${{ github.event.pull_request.number }} ${{ github.event.pull_request.title }}'
